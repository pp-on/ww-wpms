#!/bin/bash
#
# Webwerk WordPress Management Dispatcher v2.0
# Part of Webwerk WordPress Management Suite
# Focused on Barrierefreiheit (Accessibility)
#
# Description: Main dispatcher for WordPress management scripts
# Author: Webwerk Team
# License: MIT
#

set -euo pipefail

# Get script directory (resolve symlinks to actual location)
readonly SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
readonly LOG_FILE="${PWD}/webwerk.log"

#===============================================================================
# LOGGING FUNCTIONS
#===============================================================================

log_info() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] INFO: $*" | tee -a "$LOG_FILE"
}

log_error() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] ERROR: $*" | tee -a "$LOG_FILE" >&2
}

log_warning() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] WARNING: $*" | tee -a "$LOG_FILE" >&2
}

log_success() {
    echo -e "\e[32m[$(date +'%Y-%m-%d %H:%M:%S')] SUCCESS: $*\e[0m" | tee -a "$LOG_FILE"
}

#===============================================================================
# CONFIGURATION LOADING
#===============================================================================

load_environment() {
    # Load .env file if it exists
    if [[ -f "${SCRIPT_DIR}/.env" ]]; then
        log_info "Loading configuration from .env"
        set -a  # automatically export all variables
        # shellcheck source=/dev/null
        source "${SCRIPT_DIR}/.env"
        set +a
    else
        log_warning ".env file not found! Using defaults or environment variables"
    fi
}

load_license_keys() {
    # Load ~/.keys if it exists
    if [[ -f "$HOME/.keys" ]]; then
        log_info "Loading license keys from ~/.keys"
        set -a
        # shellcheck source=/dev/null
        source "$HOME/.keys"
        set +a
    else
        log_warning "~/.keys not found! License keys must be added manually"
        log_warning "Create ~/.keys file with your license keys (keep it out of repository)"
    fi
}

load_helper_functions() {
    # Source wphelpfunctions.sh from utils directory
    if [[ -f "${SCRIPT_DIR}/scripts/utils/wphelpfunctions.sh" ]]; then
        # shellcheck source=./scripts/utils/wphelpfunctions.sh
        source "${SCRIPT_DIR}/scripts/utils/wphelpfunctions.sh" || true
        log_info "Loaded helper functions from scripts/utils/"
    else
        log_error "wphelpfunctions.sh not found at ${SCRIPT_DIR}/scripts/utils/"
        log_error "Expected file structure: scripts/utils/wphelpfunctions.sh"
        exit 1
    fi
}

validate_configuration() {
    # Check if using DDEV mode
    local using_ddev=false
    for arg in "$@"; do
        if [[ "$arg" == "ddev" || "$arg" == "--ddev" || "$arg" == "--mode=ddev" ]]; then
            using_ddev=true
            break
        fi
    done

    # Validate required configuration
    local missing_config=()

    if [[ "$using_ddev" == true ]]; then
        # For DDEV mode, we only need basic config, not host system DB/WP-CLI
        log_info "DDEV mode detected - using container configuration"
        [[ -z "${WP_CLI_PATH:-}" ]] && WP_CLI_PATH="wp"  # Default for DDEV
    else
        # Check essential variables for non-DDEV installations
        [[ -z "${DB_USER:-}" ]] && missing_config+=("DB_USER")
        [[ -z "${DB_PASSWORD:-}" ]] && missing_config+=("DB_PASSWORD")
        [[ -z "${DB_HOST:-}" ]] && missing_config+=("DB_HOST")
        [[ -z "${WP_CLI_PATH:-}" ]] && missing_config+=("WP_CLI_PATH")

        if [[ ${#missing_config[@]} -gt 0 ]]; then
            log_error "Missing required configuration: ${missing_config[*]}"
            log_error "Please check your .env file or set environment variables"
            exit 1
        fi

        # Validate WP-CLI only for non-DDEV mode
        if ! command -v "$WP_CLI_PATH" &> /dev/null; then
            log_error "WP-CLI not found at: $WP_CLI_PATH"
            log_error "Please install WP-CLI or update WP_CLI_PATH in .env"
            exit 1
        fi
    fi

    log_info "Configuration validation passed"
}

#===============================================================================
# COMMAND HANDLERS
#===============================================================================

show_help() {
    cat << EOF
Webwerk WordPress Management Suite v2.0
========================================

USAGE: $0 COMMAND [OPTIONS]

COMMANDS:
  full install     Full WordPress installation with git repository
  minimal install  Minimal WordPress installation without git repository
  ddev install     DDEV-based WordPress installation
  ddev mod         Modify DDEV WordPress site (uses 'ddev wp' commands)
  ddev update      Update DDEV WordPress site (uses 'ddev wp' commands)
  ddev remove      Remove DDEV containers and configuration
  update           Update WordPress core and plugins
  mod              Modify/manage existing WordPress sites

OPTIONS:
  --debug          Enable debug mode (works with all commands)

EXAMPLES:
  $0 full install --wp-title="My Site"
  $0 ddev install -G arbeit
  $0 ddev install -n                      # Use nip.io (no hosts file needed)
  $0 ddev mod -S
  $0 ddev update                          # Update all plugins (default)
  $0 ddev update --core                   # Update core and all plugins
  $0 ddev update --plugins=plugin1,plugin2  # Update specific plugins
  $0 ddev update --dry-run                # Show what would be updated
  $0 ddev remove
  $0 minimal install
  $0 full install --debug --wp-title="Debug Site"
  $0 update --sites=site1,site2 --all
  $0 mod --sites=mysite --enable-debug

CONFIGURATION:
  Configuration is loaded from:
  1. ${SCRIPT_DIR}/.env (main configuration)
  2. ~/.keys (license keys - keep out of repository)

  Current configuration:
  - Database Host: ${DB_HOST:-'not set'}
  - Database User: ${DB_USER:-'not set'}
  - WP-CLI Path: ${WP_CLI_PATH:-'not set'}
  - Git User: ${GIT_USER:-'not set'}

FILES:
  ${SCRIPT_DIR}/.env                     Main configuration file
  ~/.keys                               License keys (ACF_PRO_LICENSE, etc.)
  ${SCRIPT_DIR}/scripts/install/        Installation scripts
  ${SCRIPT_DIR}/scripts/update/         Update scripts
  ${SCRIPT_DIR}/scripts/mod/            Modification scripts

For command-specific help, use: $0 COMMAND --help

Project: https://github.com/webwerk/wordpress-tools
EOF
}

show_status() {
    log_info "Webwerk WordPress Management Suite Status"
    echo "----------------------------------------"
    echo "Script Directory: $SCRIPT_DIR"
    echo "Configuration File: ${SCRIPT_DIR}/.env $(if [[ -f "${SCRIPT_DIR}/.env" ]]; then echo "(✓)"; else echo "(✗)"; fi)"
    echo "License Keys: ~/.keys $(if [[ -f "$HOME/.keys" ]]; then echo "(✓)"; else echo "(✗)"; fi)"
    echo "Database Host: ${DB_HOST:-'not configured'}"
    echo "Database User: ${DB_USER:-'not configured'}"
    echo "WP-CLI: ${WP_CLI_PATH:-'not configured'} $(if command -v "${WP_CLI_PATH:-wp}" &> /dev/null; then echo "(✓)"; else echo "(✗)"; fi)"
    echo "Git User: ${GIT_USER:-'not configured'}"
    echo "Log File: $LOG_FILE"
    echo ""
    
    # Check script files
    echo "Script Files:"
    local scripts=(
        "scripts/install/wplocalinstall.sh"
        "scripts/install/wpfunctionsinstall.sh"
        "scripts/update/wpupdate.sh"
        "scripts/mod/wpmod.sh"
        "scripts/utils/wphelpfunctions.sh"
    )
    
    for script in "${scripts[@]}"; do
        if [[ -f "${SCRIPT_DIR}/${script}" ]]; then
            echo "  ✓ $script"
        else
            echo "  ✗ $script (missing)"
        fi
    done
}

#===============================================================================
# MAIN EXECUTION
#===============================================================================

main() {
    local command="${1:-}"

    # Handle special cases before loading configuration
    case "$command" in
        "" | "--help" | "-h")
            show_help
            exit 0
            ;;
        "status")
            # Load config for status display
            load_environment
            load_license_keys
            show_status
            exit 0
            ;;
    esac

    # Load all configuration
    log_info "Starting Webwerk WordPress Management Suite v2.0"
    load_environment
    load_license_keys
    validate_configuration "$command" "$@"
    load_helper_functions

    # Remove first argument (command/mode)
    shift

    # Execute command
    case "$command" in
        "full" | "minimal")
            # Installation modes - expect "install" as next argument
            local subcommand="${1:-}"
            if [[ "$subcommand" != "install" ]]; then
                log_error "Expected 'install' after '$command', got: ${subcommand:-nothing}"
                log_error "Usage: $0 $command install [OPTIONS]"
                exit 1
            fi
            shift  # Remove "install" from arguments

            if [[ -f "${SCRIPT_DIR}/scripts/install/wplocalinstall.sh" ]]; then
                log_info "Executing WordPress installation (mode: $command)"
                exec bash "${SCRIPT_DIR}/scripts/install/wplocalinstall.sh" "$command" "$@"
            else
                log_error "Installation script not found: ${SCRIPT_DIR}/scripts/install/wplocalinstall.sh"
                exit 1
            fi
            ;;
        "ddev")
            # DDEV mode - expect "install" or "remove" as next argument
            local subcommand="${1:-}"
            case "$subcommand" in
                "install")
                    shift  # Remove "install" from arguments
                    if [[ -f "${SCRIPT_DIR}/scripts/install/wplocalinstall.sh" ]]; then
                        log_info "Executing WordPress installation (mode: ddev)"
                        exec bash "${SCRIPT_DIR}/scripts/install/wplocalinstall.sh" "ddev" "$@"
                    else
                        log_error "Installation script not found: ${SCRIPT_DIR}/scripts/install/wplocalinstall.sh"
                        exit 1
                    fi
                    ;;
                "remove")
                    shift  # Remove "remove" from arguments
                    log_info "Removing DDEV containers and configuration"

                    # Check if DDEV is configured
                    if [[ ! -f ".ddev/config.yaml" ]]; then
                        log_warning "No DDEV configuration found in current directory"
                        exit 0
                    fi

                    # Stop and remove DDEV containers
                    log_info "Stopping DDEV containers..."
                    ddev stop

                    log_info "Removing DDEV containers..."
                    ddev delete -O

                    log_success "DDEV containers removed successfully"
                    ;;
                "mod")
                    shift  # Remove "mod" from arguments
                    log_info "Running WordPress modification (mode: ddev)"

                    # Check if DDEV is running
                    if ! ddev status >/dev/null 2>&1; then
                        log_error "DDEV is not running. Please start DDEV first with 'ddev start'"
                        exit 1
                    fi

                    # Set DDEV-specific environment variables
                    export WP_CLI_PATH="ddev wp"
                    export WORDPRESS_BASE_DIR="."

                    if [[ -f "${SCRIPT_DIR}/scripts/mod/wpmod.sh" ]]; then
                        bash "${SCRIPT_DIR}/scripts/mod/wpmod.sh" "$@"
                    else
                        log_error "Modification script not found: ${SCRIPT_DIR}/scripts/mod/wpmod.sh"
                        exit 1
                    fi
                    ;;
                "update")
                    shift  # Remove "update" from arguments
                    log_info "Running WordPress update (mode: ddev)"

                    # Check if DDEV is running
                    if ! ddev status >/dev/null 2>&1; then
                        log_error "DDEV is not running. Please start DDEV first with 'ddev start'"
                        exit 1
                    fi

                    # Set DDEV-specific environment variables
                    export WP_CLI_PATH="ddev wp"
                    export WORDPRESS_BASE_DIR="."

                    # Initialize sites array for wp_update function (can't export arrays in bash)
                    sites=(".")

                    # Parse arguments
                    local plugins_to_update="all"
                    local update_core=false
                    local dry_run=false

                    while [[ $# -gt 0 ]]; do
                        case $1 in
                            --plugins=*)
                                plugins_to_update="${1#*=}"
                                shift
                                ;;
                            --core)
                                update_core=true
                                shift
                                ;;
                            --dry-run)
                                dry_run=true
                                shift
                                ;;
                            *)
                                shift
                                ;;
                        esac
                    done

                    # Show current WordPress version
                    log_info "Current WordPress version:"
                    ${WP_CLI_PATH} core version

                    # Check for core updates
                    if [[ "$update_core" == "true" ]] || [[ "$plugins_to_update" == "all" ]]; then
                        log_info "Checking for WordPress core updates..."
                        if ${WP_CLI_PATH} core check-update 2>&1 | grep -q "Success"; then
                            log_info "WordPress core is up to date"
                        else
                            log_info "Core updates available:"
                            ${WP_CLI_PATH} core check-update

                            if [[ "$dry_run" == "false" ]] && [[ "$update_core" == "true" ]]; then
                                log_info "Updating WordPress core..."
                                ${WP_CLI_PATH} core update
                                log_info "Updated to version:"
                                ${WP_CLI_PATH} core version
                            fi
                        fi
                    fi

                    # Show available plugin updates
                    log_info "Checking for plugin updates..."
                    local available_updates
                    available_updates=$(${WP_CLI_PATH} plugin list --update=available --format=count)

                    if [[ "$available_updates" -gt 0 ]]; then
                        log_info "$available_updates plugin(s) have updates available:"
                        ${WP_CLI_PATH} plugin list --update=available --fields=name,version,update_version

                        if [[ "$dry_run" == "true" ]]; then
                            log_info "[DRY RUN] Would update the plugins listed above"
                        else
                            # Update plugins
                            if [[ "$plugins_to_update" == "all" ]]; then
                                log_info "Updating all plugins..."
                                ${WP_CLI_PATH} plugin update --all
                            else
                                # Split comma-separated list and update each plugin
                                IFS=',' read -ra PLUGINS <<< "$plugins_to_update"
                                for plugin in "${PLUGINS[@]}"; do
                                    log_info "Updating plugin: $plugin"
                                    ${WP_CLI_PATH} plugin update "$plugin"
                                done
                            fi
                        fi
                    else
                        log_info "All plugins are up to date"
                    fi

                    log_info "DDEV update completed successfully"
                    ;;
                *)
                    log_error "Expected 'install', 'remove', 'mod', or 'update' after 'ddev', got: ${subcommand:-nothing}"
                    log_error "Usage: $0 ddev [install|remove|mod|update] [OPTIONS]"
                    exit 1
                    ;;
            esac
            ;;
        "update")
            if [[ -f "${SCRIPT_DIR}/scripts/update/wpupdate.sh" ]]; then
                log_info "Executing WordPress update"
                exec bash "${SCRIPT_DIR}/scripts/update/wpupdate.sh" "$@"
            else
                log_error "Update script not found: ${SCRIPT_DIR}/scripts/update/wpupdate.sh"
                exit 1
            fi
            ;;
        "mod")
            if [[ -f "${SCRIPT_DIR}/scripts/mod/wpmod.sh" ]]; then
                log_info "Executing WordPress modification"
                exec bash "${SCRIPT_DIR}/scripts/mod/wpmod.sh" "$@"
            else
                log_error "Modification script not found: ${SCRIPT_DIR}/scripts/mod/wpmod.sh"
                exit 1
            fi
            ;;
        *)
            log_error "Unknown command: $command"
            log_error "Use '$0 --help' for usage information"
            exit 1
            ;;
    esac
}

# Execute main function with all arguments
main "$@"
